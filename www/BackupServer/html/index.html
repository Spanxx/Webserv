<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Our beautiful webserver</title>
	<link rel="stylesheet" href="/html/style.css"> <!-- this way the request is from root, otherwise will be relative, Ex = cgi-bin/html/style.css -->
</head>
<body>

<div class="top-bar-container">
<div id="loginStatus" style="display: flex; align-items: center; font-size: 12px; gap: 10px; justify-content: flex-end; padding: 10px;">
 <span id="status"></span>  
<a href="/html/login.html" style="display: none;" id="loginBtn" class="button-link">Login</a>
<a href="/html/index.html" style="display: none;" id="logoutBtn" class="button-link">Logout</a>
</div>
</div>

<script>
    
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function showStatus() {
      const loggedIn = getCookie('logged_in');
      const statusDiv = document.getElementById('status');
      const loginBtn = document.getElementById('loginBtn');
      
      if (loggedIn === 'true') {
        statusDiv.textContent = "Logged in as {{USER}}";
        logoutBtn.style.display = 'inline-block';
      } else {
        // statusDiv.textContent = "Not logged in";
        loginBtn.style.display = 'inline-block';
      }
    }
    
    document.getElementById('logoutBtn').addEventListener('click', function() {
      window.location.href = window.location.pathname + '?login=false';
    });
    
    showStatus(); 
  </script>
    <nav>
    <ul>
      <li><a href="/index.html">Gallery</a></li>
      <li><a href="/about.html">About</a></li>
    </ul>
  </nav>
  <header>
        <h1 class="mainHeader">Gallery</h1>

	<br><br>
	 </header>
	<br>

		<h2>Upload Gallery</h2>
    	<div id="gallery">Loading...</div>
    <script>
    const gallery = document.getElementById('gallery');
	const UPLOAD_BLOCK = "{{UPLOAD_BLOCK}}";
    fetch('/{{CGI_BIN}}list_files.py') // Adjust this if needed
        .then(res => res.json())
        .then(files => {
            gallery.innerHTML = ''; // Clear loading text
		if (!files || files.length === 0) {
				gallery.innerHTML = '<p2>No files found.</p2>';
				return;
			}

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                // Display as image if image, else as link
				const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];

				if (imageExtensions.some(ext => file.toLowerCase().endsWith(ext)))
                {
                    item.innerHTML = `<a href="${UPLOAD_BLOCK}${file}" target="_blank">
                        <img src="${UPLOAD_BLOCK}${file}" alt="${file}">
                    </a>`;
                } else {
					item.innerHTML = `
						<div style="display: flex; align-items: center;">
							<span style="font-size: 2em; margin-right: 8px;">ðŸ“„</span>
							<span>${file}</span>
						</div>
					`;                }

                gallery.appendChild(item);
            });
        })
        .catch(err => {
            gallery.textContent = 'Failed to load gallery: ' + err;
        });
    </script>

	<br><br>

	<h2>Upload a File</h2>

	<form action="/{{CGI_BIN}}upload.py" class="formCenter" method="POST" enctype="multipart/form-data">
		<input type="file" name="file" id="cgiFileInput">
		<button type="submit" id="cgiUploadButton" disabled>Upload with CGI</button>
	</form>

	<form method="POST" action="{{UPLOAD_BLOCK}}" class="formCenter" enctype="multipart/form-data">
		<input type="file" name="file" id="blockFileInput"/>
		<button type="submit" id="blockUploadButton" disabled>Upload</button>
	</form>

	<br><br>

	<h2>Delete Uploaded File</h2>
	<label for="fileSelect">Choose a file:</label>
	<select id="fileSelect">
		<option value="">-- Select a file --</option>
	</select>

	<script>
	fetch('/{{CGI_BIN}}list_files.py')
		.then(res => res.json())
		.then(files => {
			const select = document.getElementById('fileSelect');
			files.forEach(file => {
				const option = document.createElement('option');
				option.value = file;
				option.textContent = file;
				select.appendChild(option);
			});
		})
		.catch(err => {
			console.error('Error loading files:', err);
		});
	</script>

	<br><br>

	<button id="deleteBtn" style="display: none;">Delete Selected File</button>
	<script>
		const select = document.getElementById('fileSelect');
		const deleteBtn = document.getElementById('deleteBtn');

		select.addEventListener('change', () => {
			deleteBtn.style.display = select.value ? 'inline-block' : 'none';
		});

		deleteBtn.addEventListener('click', () => {
			const filename = select.value;
			if (!filename) return;

			fetch(`{{UPLOAD_BLOCK}}${filename}`, {
				method: 'DELETE'
			})
			.then(response => {
				if (response.ok) {
					alert(`Deleted: ${filename}`);
					// Optionally remove from dropdown
					select.querySelector(`option[value="${filename}"]`).remove();
					select.value = '';
					deleteBtn.style.display = 'none';
				} else {
					alert('Failed to delete file.');
				}
				window.location.href = '/index.html';
			})
			.catch(error => {
				console.error('Error:', error);
				alert('Error sending request.');
			});
			// location.reload();
		});
	</script>
</body>
<script> // Script to Enable and disable upload buttons
    const cgiFileInput = document.getElementById('cgiFileInput');
    const cgiUploadButton = document.getElementById('cgiUploadButton');

    const blockFileInput = document.getElementById('blockFileInput');
    const blockUploadButton = document.getElementById('blockUploadButton');
    function toggleUploadButton(fileInput, uploadButton) {
        if (fileInput.files.length > 0) {
            uploadButton.removeAttribute('disabled');
        } else {
            uploadButton.setAttribute('disabled', 'true');
        }
    }
    cgiFileInput.addEventListener('change', function() {
        toggleUploadButton(cgiFileInput, cgiUploadButton);
    });

    blockFileInput.addEventListener('change', function() {
        toggleUploadButton(blockFileInput, blockUploadButton);
    });

    toggleUploadButton(cgiFileInput, cgiUploadButton);
    toggleUploadButton(blockFileInput, blockUploadButton);
</script>
</html>

